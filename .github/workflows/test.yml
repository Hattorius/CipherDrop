name: Test server build and run

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  test:
    runs-on: ubuntu-22.04

    steps:
    - name: Check out repository
      uses: actions/checkout@v3

    - name: Set up Docker
      uses: docker/setup-buildx-action@v2

    - name: Build backend Docker image
      run: docker compose build backend

    - name: Run PostgreSQL
      run: |
        docker compose up -d postgres

    - name: Run backend
      run: |
        docker compose up -d backend

    - name: Check if backend container is running
      run: |
        sleep 3

        TIMEOUT=20
        INTERVAL=1
        ELAPSED=0

        while [ $ELAPSED -lt $TIMEOUT ]; do
          if [ "$(docker ps --filter 'name=cipherdrop' --filter 'status=running' -q)" != "" ]; then
            echo "Backend is running"
            exit 0;
          fi

          echo "Waiting for backend to start..."
          sleep $INTERVAL;
          ELAPSED=$((ELAPSED + INTERVAL))
        done

        echo "Backend did not start within the timeout period"
        exit 1

    - name: Check if backend is running
      run: |
        curl --fail http://localhost:8080 || exit 1

    - name: Clean up Docker containers
      if: always()
      run: docker compose down
